name: scan_and_fix

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 362015461740
  ASSUME_ROLE_ARN: arn:aws:iam::362015461740:role/bedrock-test-role
  BEDROCK_MODEL_ARN: "arn:aws:bedrock:us-east-1::foundation-model/qwen.qwen3-coder-30b-a3b-v1:0"
  MOCK_BEDROCK: "true"

permissions:
  contents: write
  pull-requests: write

jobs:
  scan_and_fix:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------------
      # CHECKOUT REPO
      # --------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 1

      # --------------------------------------------------------
      # BUILD DOCKER IMAGE
      # --------------------------------------------------------
      - name: Set up Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build image
        run: |
          docker build -t vuln-sample:latest .

      # --------------------------------------------------------
      # INSTALL TRIVY (Manual Install)
      # --------------------------------------------------------
      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" \
            | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update -y
          sudo apt-get install -y trivy

      # --------------------------------------------------------
      # RUN TRIVY SCAN
      # --------------------------------------------------------
      - name: Run Trivy scan
        id: trivy_scan
        run: |
          trivy image --format json -o trivy-report.json vuln-sample:latest || true
          mkdir -p artifacts
          cp trivy-report.json artifacts/
          echo "report_path=artifacts/trivy-report.json" >> $GITHUB_OUTPUT

      # --------------------------------------------------------
      # SEND REPORT TO BEDROCK
      # --------------------------------------------------------
      - name: Get AI Patch Suggestion
        id: bedrock_suggest
        run: |
          python3 scripts/send_to_bedrock.py \
            --report artifacts/trivy-report.json \
            --model-arn "${BEDROCK_MODEL_ARN}" \
            --mock "${MOCK_BEDROCK}" \
            --out artifacts/suggested_patch.diff

          echo "patch_path=artifacts/suggested_patch.diff" >> $GITHUB_OUTPUT

      # --------------------------------------------------------
      # COMMIT PATCH INTO NEW BRANCH (FIXED - NO CP)
      # --------------------------------------------------------
      - name: Commit changes to new branch
        id: commit_patch
        run: |
          PATCH="${{ steps.bedrock_suggest.outputs.patch_path }}"
          BRANCH="auto-fix/trivy-$(date +%s)"

          if [ -s "$PATCH" ]; then
            echo "Using branch: $BRANCH"

            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            # Create fix branch from main
            git checkout main
            git pull origin main
            git checkout -b "$BRANCH"

            # DO NOT COPY â€” file already exists
            git add artifacts/suggested_patch.diff
            git add artifacts/trivy-report.json
            git add trivy-report.json

            git commit -m "chore: auto-suggested fixes from Bedrock (Qwen)"
            git push --set-upstream origin "$BRANCH"

            echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          else
            echo "No patch provided, skipping."
            exit 0
          fi

      # --------------------------------------------------------
      # CREATE PULL REQUEST
      # --------------------------------------------------------
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          branch: ${{ steps.commit_patch.outputs.branch }}
          base: main
          title: "Auto-fix: Trivy vulnerability remediation"
          body: |
            Automated patch based on Trivy scan and Bedrock AI recommendation.
          commit-message: "[create-pull-request] automated change"

name: Auto-fix Docker image vulnerabilities

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 362015461740
  BEDROCK_MODEL_ARN: "arn:aws:bedrock:us-east-1::foundation-model/qwen.qwen3-coder-30b-a3b-v1:0"
  ASSUME_ROLE_ARN: "arn:aws:iam::362015461740:role/bedrock-test-role"
  MOCK_BEDROCK: true

jobs:
  scan_and_fix:
    runs-on: ubuntu-24.04

    permissions:
      contents: write
      pull-requests: write

    steps:
      # ------------------------------------------------
      # CHECKOUT
      # ------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------
      # DOCKER BUILD
      # ------------------------------------------------
      - name: Build vuln-sample image
        run: |
          docker build -t vuln-sample:latest .

      # ------------------------------------------------
      # INSTALL TRIVY (Stable, safe)
      # ------------------------------------------------
      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update -y
          sudo apt-get install -y trivy

      # ------------------------------------------------
      # RUN TRIVY
      # ------------------------------------------------
      - name: Scan image with Trivy
        id: trivy-scan
        run: |
          trivy image --format json -o trivy-report.json vuln-sample:latest || true
          echo "report_path=trivy-report.json" >> $GITHUB_OUTPUT

      # ------------------------------------------------
      # JQ SAFE OUTPUT
      # ------------------------------------------------
      - name: Show vulnerability count safely
        run: |
          jq '.Results[]?.Vulnerabilities? // [] | length' trivy-report.json || true

      # ------------------------------------------------
      # CREATE ARTIFACTS FOLDER
      # ------------------------------------------------
      - name: Prepare artifacts
        run: |
          mkdir -p artifacts
          cp trivy-report.json artifacts/

      # ------------------------------------------------
      # RUN BEDROCK SUGGESTION (MOCK MODE)
      # ------------------------------------------------
      - name: Generate patch from Bedrock
        id: bedrock_suggest
        run: |
          python3 scripts/send_to_bedrock.py \
            --report artifacts/trivy-report.json \
            --model-arn "${BEDROCK_MODEL_ARN}" \
            --mock "true" \
            --out artifacts/suggested_patch.diff

          # Save output for next step
          echo "patch_path=artifacts/suggested_patch.diff" >> $GITHUB_OUTPUT
          echo "branch=auto-fix/trivy-$(date +%s)" >> $GITHUB_OUTPUT

      # ------------------------------------------------
      # APPLY PATCH & PUSH NEW BRANCH (but skip apply because mock)
      # ------------------------------------------------
      - name: Commit changes to new branch
        run: |
          PATCH="${{ steps.bedrock_suggest.outputs.patch_path }}"
          BRANCH="${{ steps.bedrock_suggest.outputs.branch }}"

          if [ -s "$PATCH" ]; then
            echo "[MOCK MODE] Patch exists but git apply will be skipped"

            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            git checkout -b "$BRANCH"

            # Add patch + report as files
            cp "$PATCH" artifacts/suggested_patch.diff
            git add artifacts/suggested_patch.diff
            git add artifacts/trivy-report.json
            git add trivy-report.json

            git commit -m "chore: auto-suggested fixes from Bedrock (Qwen)"
            git push --set-upstream origin "$BRANCH"
          else
            echo "No patch suggested. Exiting."
            exit 0
          fi

      # ------------------------------------------------
      # CREATE PULL REQUEST
      # ------------------------------------------------
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: auto-fix vulnerabilities using Bedrock"
          title: "Auto-fix: Trivy vulnerability remediation"
          body: |
            Automated Trivy scan + Bedrock (Qwen) fix suggestion.
          base: main
          branch: ${{ steps.bedrock_suggest.outputs.branch }}

name: Auto-fix Docker image vulnerabilities

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 362015461740
  BEDROCK_MODEL_ARN: "arn:aws:bedrock:us-east-1:362015461740:model/ANTHROPIC_SONNET_4_5_MODEL_ID" # replace with real model ARN
  ASSUME_ROLE_ARN: "arn:aws:iam::362015461740:role/bedrock-test-role" # role to assume for Bedrock invocation
  MOCK_BEDROCK: "true" # set to false to call real Bedrock (ensure credentials and model ARN are correct)

jobs:
  scan_and_fix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        run: |
          docker build -t vuln-sample:latest .

      - name: Install Trivy
        uses: aquasecurity/trivy-action@0.33.1
        

      - name: Scan image with Trivy (JSON)
        id: trivy_scan
        run: |
          trivy image --format json -o trivy-report.json vuln-sample:latest || true
          echo "report_path=trivy-report.json" >> $GITHUB_OUTPUT

      - name: Show basic scan summary
        run: |
          jq '.Results[].Vulnerabilities | length' trivy-report.json || true

      - name: Configure AWS credentials (assume role)
        if: env.MOCK_BEDROCK == 'false'
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ env.ASSUME_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Send Trivy report to Bedrock and get suggested patch
        id: bedrock_suggest
        run: |
          mkdir -p artifacts
          cp trivy-report.json artifacts/
          python3 scripts/send_to_bedrock.py \
            --report artifacts/trivy-report.json \
            --model-arn "${{ env.BEDROCK_MODEL_ARN }}" \
            --mock "${{ env.MOCK_BEDROCK }}" \
            --out artifacts/suggested_patch.diff
          echo "patch_path=artifacts/suggested_patch.diff" >> $GITHUB_OUTPUT
        env:
          AWS_REGION: ${{ env.AWS_REGION }}

      - name: Create branch and apply suggested patch
        if: steps.bedrock_suggest.outputs.patch_path != ''
        run: |
          PATCH=${{ steps.bedrock_suggest.outputs.patch_path }}
          if [ -s "$PATCH" ]; then
            BRANCH="auto-fix/trivy-$(date +%s)"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git checkout -b "$BRANCH"
            cp "$PATCH" /tmp/suggested.diff
            git apply /tmp/suggested.diff || (echo "git apply failed" && exit 1)
            git add -A
            git commit -m "chore: apply auto-suggested fixes from Bedrock"
            git push --set-upstream origin "$BRANCH"
            echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          else
            echo "No patch suggested by Bedrock. Exiting."
            exit 0
          fi

      - name: Rebuild image on patched branch and rescan
        if: steps.bedrock_suggest.outputs.patch_path != ''
        run: |
          BRANCH=${{ steps.bedrock_suggest.outputs.branch || steps.bedrock_suggest.outputs.branch }}
          # Use local branch
          docker build -t vuln-sample:patched .
          trivy image --format json -o trivy-report-after.json vuln-sample:patched || true
          cat trivy-report-after.json
          jq '.Results[].Vulnerabilities | length' trivy-report-after.json || true

      - name: Create Pull Request if vulnerabilities are fixed
        if: steps.bedrock_suggest.outputs.patch_path != ''
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: apply auto-suggested fixes from Bedrock"
          title: "Auto-fix: Vulnerabilities addressed by Bedrock suggestion"
          body: |
            This PR applies automated fixes suggested by Bedrock (Anthropic Sonnet). The workflow:
            - Scanned the docker image with Trivy
            - Sent findings to Bedrock
            - Applied suggested patch
            - Rebuilt and re-scanned

          base: main
          head: ${{ steps.bedrock_suggest.outputs.branch }}

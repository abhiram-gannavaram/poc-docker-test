name: Auto-fix Docker image vulnerabilities

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  security-events: write
  pull-requests: write

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 362015461740
  BEDROCK_MODEL_ARN: "arn:aws:bedrock:us-east-1:362015461740:model/ANTHROPIC_SONNET_4_5_MODEL_ID" # update if needed
  ASSUME_ROLE_ARN: "arn:aws:iam::362015461740:role/bedrock-test-role"
  MOCK_BEDROCK: "true" # set to "false" to call Bedrock for real
  IMAGE_NAME: "vuln-sample"

jobs:
  scan_and_fix:
    runs-on: ubuntu-latest
    outputs:
      created_pr_url: ${{ steps.create_pr.outputs.pull-request-url || '' }}
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image (initial)
        run: |
          docker build -t $IMAGE_NAME:latest .

      - name: Run Trivy vulnerability scanner (fs -> JSON)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          trivy-config: trivy.yaml
          format: 'json'
          output: 'trivy-report.json'

      - name: Show basic scan summary
        run: |
          if [ -f trivy-report.json ] && [ -s trivy-report.json ]; then
            echo "Trivy per-target vulnerability counts (target: vulnerabilities):"
            jq -r '.Results[]? | (.Target // "<unknown>") + ": " + ((.Vulnerabilities // []) | length | tostring)' trivy-report.json || true
            TOTAL=$(jq '[.Results[]? | (.Vulnerabilities // [])[]?] | length' trivy-report.json 2>/dev/null || echo 0)
            echo "Total vulnerabilities: $TOTAL"
            echo "trivy_total_vulnerabilities=$TOTAL" >> $GITHUB_OUTPUT
          else
            echo "trivy-report.json missing or empty"
            echo "trivy_total_vulnerabilities=0" >> $GITHUB_OUTPUT
          fi

      - name: Decide whether to call Bedrock (HIGH + CRITICAL)
        id: decide_bedrock
        run: |
          if [ ! -f trivy-report.json ] || [ ! -s trivy-report.json ]; then
            echo "call_bedrock=false" >> $GITHUB_OUTPUT
            echo "high=0" >> $GITHUB_OUTPUT
            echo "critical=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          HIGH=$(jq '[.Results[]? | (.Vulnerabilities // [])[]? | select(.Severity=="HIGH")] | length' trivy-report.json 2>/dev/null || echo 0)
          CRIT=$(jq '[.Results[]? | (.Vulnerabilities // [])[]? | select(.Severity=="CRITICAL")] | length' trivy-report.json 2>/dev/null || echo 0)

          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "critical=$CRIT" >> $GITHUB_OUTPUT
          if [ "$((HIGH + CRIT))" -eq 0 ]; then
            echo "call_bedrock=false" >> $GITHUB_OUTPUT
          else
            echo "call_bedrock=true" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS credentials (try OIDC role-to-assume)
        id: configure_oidc
        if: env.MOCK_BEDROCK == 'false'
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ env.ASSUME_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
        continue-on-error: true

      - name: Configure AWS credentials (fallback to secrets)
        if: env.MOCK_BEDROCK == 'false' && steps.configure_oidc.outcome == 'failure'
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Ensure scripts executable
        run: |
          chmod +x scripts/send_to_bedrock.py || true

      - name: Send Trivy report to Bedrock and get suggested patch
        id: bedrock_suggest
        if: steps.decide_bedrock.outputs.call_bedrock == 'true'
        run: |
          set -euo pipefail
          mkdir -p artifacts
          cp trivy-report.json artifacts/
          python3 scripts/send_to_bedrock.py \
            --report artifacts/trivy-report.json \
            --model-arn "${{ env.BEDROCK_MODEL_ARN }}" \
            --mock "${{ env.MOCK_BEDROCK }}" \
            --out artifacts/suggested_patch.diff || true
          if [ -s artifacts/suggested_patch.diff ]; then
            echo "patch_path=artifacts/suggested_patch.diff" >> $GITHUB_OUTPUT
          else
            echo "patch_path=" >> $GITHUB_OUTPUT
          fi

      - name: Check generated patch
        id: check_patch
        run: |
          set -euo pipefail
          PATCH="${{ steps.bedrock_suggest.outputs.patch_path }}"
          mkdir -p artifacts
          if [ -z "$PATCH" ] || [ ! -s "$PATCH" ]; then
            echo "No patch file or file empty. Skipping."
            echo "patch_exists=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Basic sanity check for unified diff content (diff header or ---/+++ lines)
          if grep -qE '^(diff --git |--- a/|\+\+\+ b/)' "$PATCH"; then
            echo "patch_exists=true" >> $GITHUB_OUTPUT
          else
            echo "patch_exists=false" >> $GITHUB_OUTPUT
          fi

          # Save a truncated preview for debugging
          head -n 200 "$PATCH" > artifacts/patch_preview.txt || true
          echo "wrote artifacts/patch_preview.txt"

      - name: Validate & apply patch (create branch)
        id: create_branch
        if: steps.check_patch.outputs.patch_exists == 'true'
        run: |
          set -euo pipefail
          PATCH="${{ steps.bedrock_suggest.outputs.patch_path }}"
          if [ ! -s "$PATCH" ]; then
            echo "No patch found; exiting"
            echo "branch=" >> $GITHUB_OUTPUT
            exit 0
          fi

          BRANCH="auto-fix/trivy-$(date +%s)"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          cp "$PATCH" /tmp/suggested.diff

          # run git apply --check first to ensure the patch applies cleanly
          if ! git apply --check /tmp/suggested.diff; then
            echo "git apply --check failed. Writing diagnostics and skipping patch application."
            echo "apply_check_failed=true" >> $GITHUB_OUTPUT
            echo "branch=" >> $GITHUB_OUTPUT
            # Save model preview for debugging (truncated)
            mkdir -p artifacts
            head -c 2000 /tmp/suggested.diff > artifacts/patch_preview.txt || true
            echo "wrote artifacts/patch_preview.txt"
            # Do not fail the job - treat as no-op so downstream steps are skipped
            exit 0
          fi

          git apply /tmp/suggested.diff
          git add -A
          # commit if there are changes
          if git diff --cached --quiet; then
            echo "No changes to commit after applying patch"
          else
            git commit -m "chore: apply auto-suggested fixes from Bedrock"
          fi
          git push --set-upstream origin "$BRANCH"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Rebuild image on patched branch
        if: steps.create_branch.outputs.branch != ''
        run: |
          docker build -t $IMAGE_NAME:patched .

      - name: Scan patched image with Trivy (image -> JSON)
        if: steps.create_branch.outputs.branch != ''
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'image'
          scan-ref: '${{ env.IMAGE_NAME }}:patched'
          format: 'json'
          output: 'trivy-report-after.json'

      - name: Show before/after summary and decide PR creation
        id: summarize_after
        run: |
          set -euo pipefail
          # original counts from earlier step outputs (fallback to 0)
          ORIG_HIGH=${{ steps.decide_bedrock.outputs.high || '0' }}
          ORIG_CRIT=${{ steps.decide_bedrock.outputs.critical || '0' }}

          if [ -f trivy-report-after.json ] && [ -s trivy-report-after.json ]; then
            NEW_HIGH=$(jq '[.Results[]? | (.Vulnerabilities // [])[]? | select(.Severity=="HIGH")] | length' trivy-report-after.json 2>/dev/null || echo 0)
            NEW_CRIT=$(jq '[.Results[]? | (.Vulnerabilities // [])[]? | select(.Severity=="CRITICAL")] | length' trivy-report-after.json 2>/dev/null || echo 0)
          else
            NEW_HIGH=0
            NEW_CRIT=0
          fi

          echo "orig_high=$ORIG_HIGH" >> $GITHUB_OUTPUT
          echo "orig_crit=$ORIG_CRIT" >> $GITHUB_OUTPUT
          echo "new_high=$NEW_HIGH" >> $GITHUB_OUTPUT
          echo "new_crit=$NEW_CRIT" >> $GITHUB_OUTPUT

          ORIG_SUM=$((ORIG_HIGH + ORIG_CRIT))
          NEW_SUM=$((NEW_HIGH + NEW_CRIT))

          echo "orig_sum=$ORIG_SUM" >> $GITHUB_OUTPUT
          echo "new_sum=$NEW_SUM" >> $GITHUB_OUTPUT

          if [ "$NEW_SUM" -lt "$ORIG_SUM" ]; then
            echo "create_pr=true" >> $GITHUB_OUTPUT
          else
            echo "create_pr=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request if vulnerabilities improved
        id: create_pr
        if: steps.create_branch.outputs.branch != '' && steps.summarize_after.outputs.create_pr == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: apply auto-suggested fixes from Bedrock"
          title: "Auto-fix: Vulnerabilities addressed by Bedrock suggestion"
          body: |
            This PR applies automated fixes suggested by Bedrock.

            Summary:
            - Original HIGH: ${{ steps.summarize_after.outputs.orig_high }}
            - Original CRITICAL: ${{ steps.summarize_after.outputs.orig_crit }}
            - New HIGH: ${{ steps.summarize_after.outputs.new_high }}
            - New CRITICAL: ${{ steps.summarize_after.outputs.new_crit }}

            Notes:
            - Patch was produced by an automated model (Bedrock) and validated with `git apply --check`.
            - Please review changes before merging; automated patches should be validated in downstream tests.
          base: main
          head: ${{ steps.create_branch.outputs.branch }}

      - name: Print results
        run: |
          echo "Original HIGH/CRITICAL: ${{ steps.summarize_after.outputs.orig_high }}/${{ steps.summarize_after.outputs.orig_crit }}"
          echo "New HIGH/CRITICAL: ${{ steps.summarize_after.outputs.new_high }}/${{ steps.summarize_after.outputs.new_crit }}"
          echo "Patch path: ${{ steps.bedrock_suggest.outputs.patch_path || 'none' }}"
          echo "Created branch: ${{ steps.create_branch.outputs.branch || 'none' }}"
          echo "PR url: ${{ steps.create_pr.outputs.pull-request-url || 'none' }}"

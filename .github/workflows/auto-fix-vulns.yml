name: Auto-fix Docker image vulnerabilities

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 362015461740
  BEDROCK_MODEL_ARN: "arn:aws:bedrock:us-east-1:362015461740:model/ANTHROPIC_SONNET_4_5_MODEL_ID" # replace with real model ARN
  ASSUME_ROLE_ARN: "arn:aws:iam::362015461740:role/bedrock-test-role" # role to assume for Bedrock invocation
  MOCK_BEDROCK: "false" # set to "true" to mock Bedrock (no AWS credentials required). Set to "false" to call real Bedrock (ensure credentials and model ARN are correct)

jobs:
  scan_and_fix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        run: |
          docker build -t vuln-sample:latest .

      - name: Run Trivy vulnerability scanner in fs mode
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          trivy-config: trivy.yaml
          format: 'json'
          output: 'trivy-report.json'

      - name: Show basic scan summary
        run: |
          if [ -f trivy-report.json ]; then
            echo "Trivy findings summary (target: #vulnerabilities):"
            # Safely handle cases where .Vulnerabilities may be null
            jq -r '.Results[] | (.Target // "<unknown>") + ": " + ((.Vulnerabilities // []) | length | tostring)' trivy-report.json || true
          else
            echo "trivy-report.json not found"
          fi

      - name: Trivy jq-safe diagnostics & total count
        run: |
          if [ ! -f trivy-report.json ]; then
            echo "trivy-report.json not found - skipping diagnostics"
            echo "trivy_total_vulnerabilities=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "--- trivy-report.json (first 200 lines) ---"
          sed -n '1,200p' trivy-report.json || true
          echo "--- per-target vulnerability counts ---"
          # Print per-target counts safely (handles null Vulnerabilities)
          jq -r '.Results[] | (.Target // "<unknown>") + ": " + ((.Vulnerabilities // []) | length | tostring)' trivy-report.json || true
          # Compute total vulnerabilities across all results (handle nulls)
          TOTAL=$(jq '[.Results[]? | (.Vulnerabilities // [])[]?] | length' trivy-report.json 2>/dev/null || echo 0)
          echo "Total vulnerabilities: $TOTAL"
          echo "trivy_total_vulnerabilities=$TOTAL" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials (assume role)
        if: env.MOCK_BEDROCK == 'false'
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ env.ASSUME_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Send Trivy report to Bedrock and get suggested patch
        id: bedrock_suggest
        run: |
          set -e
          mkdir -p artifacts
          cp trivy-report.json artifacts/
          python3 scripts/send_to_bedrock.py \
            --report artifacts/trivy-report.json \
            --model-arn "${{ env.BEDROCK_MODEL_ARN }}" \
            --mock "${{ env.MOCK_BEDROCK }}" \
            --out artifacts/suggested_patch.diff || true
          # if file exists and non-empty, set output; otherwise set empty output
          if [ -s artifacts/suggested_patch.diff ]; then
            echo "patch_path=artifacts/suggested_patch.diff" >> $GITHUB_OUTPUT
          else
            echo "patch_path=" >> $GITHUB_OUTPUT
          fi
        env:
          AWS_REGION: ${{ env.AWS_REGION }}

      - name: Create branch and apply suggested patch
        id: create_branch
        if: steps.bedrock_suggest.outputs.patch_path != ''
        run: |
          set -e
          PATCH="${{ steps.bedrock_suggest.outputs.patch_path }}"
          if [ -s "$PATCH" ]; then
            BRANCH="auto-fix/trivy-$(date +%s)"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git checkout -b "$BRANCH"
            cp "$PATCH" /tmp/suggested.diff
            git apply /tmp/suggested.diff || (echo "git apply failed" && exit 1)
            git add -A
            git commit -m "chore: apply auto-suggested fixes from Bedrock"
            git push --set-upstream origin "$BRANCH"
            echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          else
            echo "No patch suggested by Bedrock. Exiting."
            exit 0
          fi

      - name: Rebuild image on patched branch
        if: steps.bedrock_suggest.outputs.patch_path != ''
        run: |
          docker build -t vuln-sample:patched .

      - name: Scan patched image with Trivy (JSON)
        if: steps.bedrock_suggest.outputs.patch_path != ''
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'image'
          scan-ref: 'vuln-sample:patched'
          format: 'json'
          output: 'trivy-report-after.json'

      - name: Show patched scan summary
        if: steps.bedrock_suggest.outputs.patch_path != ''
        run: |
          cat trivy-report-after.json || true
          # Safely handle null Vulnerabilities fields when summarizing
          jq -r '.Results[] | (.Target // "<unknown>") + ": " + ((.Vulnerabilities // []) | length | tostring)' trivy-report-after.json || true

      - name: Create Pull Request if vulnerabilities are fixed
        if: steps.bedrock_suggest.outputs.patch_path != ''
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: apply auto-suggested fixes from Bedrock"
          title: "Auto-fix: Vulnerabilities addressed by Bedrock suggestion"
          body: |
            This PR applies automated fixes suggested by Bedrock (Anthropic Sonnet). The workflow:
            - Scanned the docker image with Trivy
            - Sent findings to Bedrock
            - Applied suggested patch
            - Rebuilt and re-scanned
          base: main
          head: ${{ steps.create_branch.outputs.branch }}

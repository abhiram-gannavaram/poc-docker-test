name: Auto-fix Docker image vulnerabilities

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 362015461740

  # Qwen model (global Bedrock foundation model)
  BEDROCK_MODEL_ARN: "arn:aws:bedrock:us-east-1::foundation-model/qwen.qwen3-coder-30b-a3b-v1:0"

  # IAM role that GitHub OIDC will assume
  ASSUME_ROLE_ARN: "arn:aws:iam::362015461740:role/bedrock-test-role"

  # Mock mode for testing without Bedrock calls
  MOCK_BEDROCK: "true"   # set to "false" when calling real Bedrock

jobs:
  scan_and_fix:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        run: |
          docker build -t vuln-sample:latest .

      # ------------------------------------------------------
      # MANUAL TRIVY INSTALL (stable, no auto-overrides)
      # ------------------------------------------------------
      - name: Install Trivy CLI
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget tar
          wget -q https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.45.0_Linux-64bit.tar.gz -O trivy.tar.gz
          sudo tar zxvf trivy.tar.gz --exclude=LICENSE --exclude=README.md -C /usr/local/bin trivy

      # ------------------------------------------------------
      # SCAN THE IMAGE DIRECTLY (never scans ".")
      # ------------------------------------------------------
      - name: Scan image with Trivy (JSON)
        id: trivy_scan
        run: |
          trivy image --format json -o trivy-report.json vuln-sample:latest || true
          echo "report_path=trivy-report.json" >> $GITHUB_OUTPUT

      - name: Show basic scan summary
        run: |
          jq '.Results[].Vulnerabilities | length' trivy-report.json || true

      # ------------------------------------------------------
      # ASSUME ROLE FOR REAL BEDROCK
      # ------------------------------------------------------
      - name: Configure AWS credentials (assume role)
        if: env.MOCK_BEDROCK == 'false'
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ASSUME_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # ------------------------------------------------------
      # SEND TRIVY REPORT TO BEDROCK (QWEN)
      # ------------------------------------------------------
      - name: Send Trivy report to Bedrock (Qwen) and get suggested patch
        id: bedrock_suggest
        run: |
          mkdir -p artifacts
          cp trivy-report.json artifacts/

          python3 scripts/send_to_bedrock.py \
            --report artifacts/trivy-report.json \
            --model-arn "${{ env.BEDROCK_MODEL_ARN }}" \
            --mock "${{ env.MOCK_BEDROCK }}" \
            --out artifacts/suggested_patch.diff

          echo "patch_path=artifacts/suggested_patch.diff" >> $GITHUB_OUTPUT
        env:
          AWS_REGION: ${{ env.AWS_REGION }}

      # ------------------------------------------------------
      # APPLY PATCH AND PUSH TO NEW BRANCH
      # ------------------------------------------------------
      - name: Create branch and apply suggested patch
        if: steps.bedrock_suggest.outputs.patch_path != ''
        run: |
          PATCH=${{ steps.bedrock_suggest.outputs.patch_path }}
          if [ -s "$PATCH" ]; then
            BRANCH="auto-fix/trivy-$(date +%s)"

            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            git checkout -b "$BRANCH"
            cp "$PATCH" /tmp/suggested.diff

            git apply /tmp/suggested.diff || (echo "git apply failed" && exit 1)
            git add -A
            git commit -m "chore: apply auto-suggested fixes from Bedrock (Qwen)"
            git push --set-upstream origin "$BRANCH"

            echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          else
            echo "No patch suggested by Bedrock. Exiting."
            exit 0
          fi

      # ------------------------------------------------------
      # REBUILD & RESCAN AFTER PATCH
      # ------------------------------------------------------
      - name: Rebuild image on patched branch and rescan
        if: steps.bedrock_suggest.outputs.patch_path != ''
        run: |
          docker build -t vuln-sample:patched .
          trivy image --format json -o trivy-report-after.json vuln-sample:patched || true
          cat trivy-report-after.json
          jq '.Results[].Vulnerabilities | length' trivy-report-after.json || true

      # ------------------------------------------------------
      # CREATE PR
      # ------------------------------------------------------
      - name: Create Pull Request if vulnerabilities are fixed
        if: steps.bedrock_suggest.outputs.patch_path != ''
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: auto-fix vulnerabilities using Bedrock (Qwen)"
          title: "Auto-fix: Vulnerabilities addressed by Bedrock (Qwen)"
          body: |
            This PR applies automated fixes suggested by AWS Bedrock using the **Qwen coder model**.

            Steps:
            - Built Docker image
            - Scanned with Trivy CLI
            - Sent findings to Bedrock (Qwen)
            - Applied patch automatically
            - Rebuilt and re-scanned

          base: main
          head: ${{ steps.bedrock_suggest.outputs.branch }}
